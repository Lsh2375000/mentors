<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/inc.html}" xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="UTF-8">
  <title>결제하기</title>
  <script src="https://js.tosspayments.com/v1/payment"></script>

  <style>
    .payment-box {
      text-align: center;
      margin: 20px auto;
      padding: 20px;
      border: 2px solid #007b7f; /* 두꺼운 테두리 */
      border-radius: 15px; /* 둥근 테두리 */
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); /* 그림자 */
      max-width: 600px; /* 적절한 최대 너비 지정 */
    }

    h1 {
    }

    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }

    img {
      max-width: 100px; /* 이미지 최대 너비 지정 */
      height: auto;
    }

    .payment-button {
      background-color: #28a745;
      color: #fff;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .payment-button:hover {
      background-color: #218838;
    }
  </style>

</head>

<body>
<div layout:fragment="content">
  <div class="payment-box">
    <h1>쿠키샵</h1>
    <table>
      <thead>
      <tr>
        <th>이미지</th>
        <th>제목</th>
        <th>금액</th>
        <th>구매하기</th>
      </tr>
      </thead>
      <tbody>
      <tr>
        <td><img src="/img/basic/coin.png" alt="상품 이미지"></td>
        <td class="product">쿠키 1개</td>
        <td class="product-price">1000</td>
        <td><button class="payment-button btn-success">구매하기</button></td>
      </tr>
      <tr>
        <td><img src="/img/basic/coin.png" alt="상품 이미지"></td>
        <td class="product">쿠키 10개</td>
        <td class="product-price">10000</td>
        <td><button class="payment-button btn-success">구매하기</button></td>
      </tr>
      <tr>
        <td><img src="/img/basic/coin.png" alt="상품 이미지"></td>
        <td class="product">쿠키 30개</td>
        <td class="product-price">30000</td>
        <td><button class="payment-button btn-success">구매하기</button></td>
      </tr>
      <tr>
        <td><img src="/img/basic/coin.png" alt="상품 이미지"></td>
        <td class="product">쿠키 50개</td>
        <td class="product-price">50000</td>
        <td><button class="payment-button btn-success">구매하기</button></td>
      </tr>
      <tr>
        <td><img src="/img/basic/coin.png" alt="상품 이미지"></td>
        <td class="product">쿠키 100개</td>
        <td class="product-price">100000</td>
        <td><button class="payment-button btn-success">구매하기</button></td>
      </tr>
      <!-- 추가 상품은 필요에 따라 계속해서 추가할 수 있습니다. -->
      </tbody>
    </table>

    <!-- 학교 api -->
    <input type = "text" id="word" placeholder="검색어를 입력하세요."
           onkeyup="search(this);"><button type="button" id="btn_search">Search</button>
    <ul id="schoolList"></ul>
    <!-- 학교 api -->
  </div>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="/js/payment.js?1"></script>
</div>
<script layout:fragment="script" th:inline="javascript">
  // ------ 클라이언트 키로 객체 초기화 ------
  const clientKey = 'test_ck_KNbdOvk5rkoYXjgPBaYErn07xlzm'
  const tossPayments = TossPayments(clientKey)
  const auth = [[${#authentication.principal}]];

  // ------ 충전하기 버튼에 기능 추가 ------
  const buttons = document.querySelectorAll('.payment-button') // 충전하기 버튼
  buttons.forEach(function(button) {
    button.addEventListener('click', function () {
      if(auth ==='anonymousUser'){
        alert('로그인을 해주세요.');
        return;
      }
      const product = this.closest('tr').querySelector('.product').textContent;
      const price = this.closest('tr').querySelector('.product-price').textContent;

      console.log(product);
      console.log(price);

      const tossObj = {payType: 'toss', amount: price, orderName: product};

      //결제요청 데이터 저장
      axios.post('/payment/toss', tossObj)
              .then(response => {
                console.log('서버 응답:', response.data);

                const reqOrderId = response.data.orderId;

                // ------ 결제창 띄우기 ------
                tossPayments.requestPayment('CARD', {
                  amount: price,
                  orderId: reqOrderId,
                  orderName: product,
                  customerName: auth.memberName,
                  successUrl: window.location.origin + '/payments/success',
                  failUrl: window.location.origin + '/payments/fail',
                })
              })
              .catch(error => {
                console.error('에러 발생:', error);
              });
    })
  });






  const schoolList = document.querySelector('#schoolList');
  //학교정보 api
  function search(target){
    let word = target.value;
    let encodeWord = encodeURI(word);
    console.log(word);
    console.log(encodeWord);

    axios.get('http://www.career.go.kr/cnet/openapi/getOpenApi', {
      params: {
        apiKey: 'f36c8f366dd9eccf65b6a7deb149d558',
        svcType: 'api',
        svcCode: 'SCHOOL',
        contentType: 'json',
        gubun: 'univ_list',
        searchSchulNm: word
      }
    })
            .then(response => {
              // 성공적으로 데이터를 받아온 경우의 처리
              console.log(response.data);
              schoolList.innerHTML = '';
              let word = document.getElementById("word").value; // 검색어 입력값
              console.log(response.data.dataSearch.content.length);

              if (word.length > 0 && response.data.dataSearch.content.length > 0) {
                for (let i = 0; i < response.data.dataSearch.content.length; i++) {
                  let li = document.createElement("li");
                  li.className = 'schoolList';
                  li.value = response.data.dataSearch.content[i].schoolName;
                  li.setAttribute('data-input', response.data.dataSearch.content[i].schoolName);

                  var a = document.createElement("a");
                  a.href = '';
                  a.innerHTML = response.data.dataSearch.content[i].schoolName;

                  li.appendChild(a);
                  schoolList.appendChild(li);
                }
              }
            })
            .catch(error => {
              // 오류가 발생한 경우의 처리
              console.error('실행중 오류가 발생하였습니다.', error);
            });
  }
</script>
</body>
</html>