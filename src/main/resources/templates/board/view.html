<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/inc.html}">

<head>
    <meta charset="UTF-8">
    <title>ìƒì„¸í˜ì´ì§€</title>
</head>

<body>


<div layout:fragment="content">
    <style>
        * { margin: 0; padding: 0; }
        ul, li { list-style: none; padding-left: 0; }
        a { text-decoration: none; }

        .view-container { background-color: #FFFFFF; }
        .view-body { min-height: 600px; }
        .view-footer { padding: 20px; text-align: right; }
        .comment-container { background-color: #f8f9fa; padding: 50px; }
        .comment-container #comment-input { line-height: 2; }
        .comment-list { padding-top: 40px; }
        .comment { margin-bottom: 20px; padding: 20px 30px; border-radius: 5px; border: 1px solid #dee2e6; background-color: #FFFFFF; }
        .edit-btn-area button { background: none; border: none; text-decoration-line: underline; color: #6c757d; }
        .comment-body .btn-area { margin-top: 1rem; }
        .btn-area button { font-weight: 600; }
        .reply-list { margin: 20px 0; }
        .reply { border-left: 5px solid #dee2e6; padding: 15px; }
        .hide { display: none; }
    </style>

    <main>
        <div th:with="link = ${pageRequestDTO.getLink()}">
            <a th:href="|@{/board/list}?${link}|" class="text-decoration-none">
                <button type="button" class="btn btn-primary">ğŸ“‹ ë’¤ë¡œê°€ê¸°</button>
            </a>
            <th:block th:if="${#authentication.principal != 'anonymousUser'}">
                <a th:href="|@{/board/modify(boardNo=${board.boardNo})}&${link}|">
                    <button type="button" class="btn btn-secondary">âœ ìˆ˜ì •</button>
                </a>
            </th:block>
        </div>

        <!-- ê²Œì‹œê¸€ ì„¹ì…˜ -->
        <section class="view-container">

            <h1>[[${board.title}]]</h1>
            <div class="view-header">
                <h6><a href="#">[[${board.writer}]]</a></h6>
                <span>ì‘ì„±ì¼ &nbsp;[[${#temporals.format(board.addDate, 'yyyy-MM-dd HH:mm')}]]</span>
                <span>ì¡°íšŒìˆ˜ &nbsp;[[${board.replyCount}]]</span>
            </div>
            <hr>
            <div class="view-body" th:utext="${board.content}"></div>
            <div class="view-footer">
                <form action="/board/remove" method="post">
                    <button type="button" id="likeBtn" class="btn btn-primary">ì¢‹ì•„ìš”</button>
                    <a th:href="|@{/board/modify(boardNo=${board.boardNo})}&${link}|">
                        <button type="button" class="btn btn-secondary">âœ ìˆ˜ì •</button>
                    </a>
                    <button type="submit" id="removeBtn" class="btn btn-danger">ì‚­ì œ</button>
                </form>
            </div>

            <script th:inline="javascript">
                // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë²¤íŠ¸
                const boardNo = [[${board.boardNo}]];
                document.getElementById('removeBtn').addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const form = document.querySelector('.view-footer form');

                    if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        form.innerHTML += `<input type="hidden" name="boardNo" value="${boardNo}">`;
                        form.submit();
                    }
                });

            </script>

        </section>

        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
        <section class="comment-container">
            <h3>ëŒ“ê¸€ <span>[[${board.replyCount}]]</span></h3>
            <input type="text" id="comment-input" name="content" class="form-control" placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”">
            <ul class="comment-list">

            </ul>
            <ul class="pagination reply-paging">

            </ul>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/board/board.js"></script>
    <script src="/js/reply.js"></script>

</div> <!-- reply end -->
</body>
<script layout:fragment="script" th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const boardNo = [[${board.boardNo}]];
        const likeList = [[${board.likeList}]];
        const mno = 2; // íšŒì› ê³ ìœ ë²ˆí˜¸ í…ŒìŠ¤íŠ¸

        let isLike = false; // ì¢‹ì•„ìš” ìœ ë¬´ í™•ì¸
        for (const like of likeList) {
            isLike = (like.mno === mno);
        }

        let blNo = 8; // ì¢‹ì•„ìš” ê³ ìœ ë²ˆí˜¸ë¥¼ ë‹´ì„ ë³€ìˆ˜
        document.getElementById('likeBtn').addEventListener('click', async function (e) { // ì¢‹ì•„ìš” í´ë¦­ ì´ë²¤íŠ¸
            e.preventDefault();
            e.stopPropagation();

            const boardLikeDTO = { boardNo: boardNo, mno: 2 }; // ì¢‹ì•„ìš” ì •ë³´ë¥¼ ë‹´ì„ ê°ì²´
            console.log(likeList);

            if (isLike) { // ì¢‹ì•„ìš”ë¥¼ í•œê²½ìš°
                const result = await removeLike(blNo);
                console.log(result);
                isLike = !result;
            }
            else {
                const result = await addLike(boardLikeDTO);
                blNo = result.blNo;
                console.log(blNo);
                isLike = true;
            }
        });

        function printReplies(page, size, goLast){
            getList({boardNo, page, size, goLast}).then(
                data => {console.log(data);
                    printList(data.dtoList);
                    printPages(data);
                }
            ).catch(e => {
                console.error();
            });
        }
        printReplies(1, 10); //ë¬´ì¡°ê±´ í˜¸ì¶œ
        // printReplies(1, 10, true);

        const commentList = document.querySelector('.comment-list');//ëŒ“ê¸€ ëª©ë¡ DOM
        const replyPaging = document.querySelector('.reply-paging'); //í˜ì´ì§€ ëª©ë¡ DOM

        function printList(dtoList) { //ëŒ“ê¸€ ëª©ë¡ ì¶œë ¥
            let str = '';
            let date;
            let dateFomatter;
            if (dtoList && dtoList.length > 0){
                for(const comment of dtoList){ // ëŒ“ê¸€
                    date = comment.addDate; // ëŒ“ê¸€ ë“±ë¡ ë‚ ì§œ
                    dateFomatter = `${date[0]}.${date[1].toString().padStart(2, '0')}.${date[2].toString().padStart(2, '0')}
                        ${date[3]}:${date[4].toString().padStart(2, '0')}`; // ë‚ ì§œ í¬ë§·
                    console.log(date);
                    str += `<li class ="comment" id="${comment.rno}">
                                <div class="comment-header">
                                    <h6><a href="#">${comment.writer}</a></h6>
                                    <span>${dateFomatter}</span>
                                    <span>${!comment.cmEdtNot ? 'ìˆ˜ì •ë¨' : ''}</span>
                                    <span class="edit-btn-area">
                                        <button class="mod-comment-btn">ìˆ˜ì •</button>
                                        <button class="remove-comment-btn">ì‚­ì œ</button>
                                    </span>
                                </div>
                                <hr>
                                <div class="comment-body">
                                    <p>${comment.content}</p>
                                    <input type="text" name="content" class="form-control mod-input hide" value="${comment.content}">
                                    <div class="btn-area" data-reply-count="${comment.children.length}">
                                        <button class="hide-btn btn btn-outline-primary
                                            ${comment.children.length <= 0 ? 'hide' : ''}">â–³ ìˆ¨ê¸°ê¸°</button>
                                        <button class="reg-reply-btn btn btn-outline-primary">ë‹µê¸€ë‹¬ê¸°</button>
                                    </div>
                                </div>
                                <ul class="reply-list">`;
                    for (const reply of comment.children) { // ëŒ€ëŒ“ê¸€
                        date = reply.addDate; // ëŒ€ëŒ“ê¸€ ë“±ë¡ ë‚ ì§œ
                        dateFomatter = `${date[0]}.${date[1].toString().padStart(2, '0')}.${date[2].toString().padStart(2, '0')}
                            ${date[3]}:${date[4].toString().padStart(2, '0')}`; // ë‚ ì§œ í¬ë§·
                        str += `<li class="reply">
                                <div>
                                    <span>${reply.writer}</span>
                                    <span>&nbsp;Â·&nbsp;</span>
                                    <span>${dateFomatter}</span>
                                </div>
                                <p>${reply.content}</p>
                             </li>`;
                    }
                    str += `</ul>
                            <input type="text" name="content" class="form-control reply-input hide" placeholder="ë‹µë³€ì„ ì‘ì„±í•´ë³´ì„¸ìš”">
                        </li>`;
                }
            }
            commentList.innerHTML = str;

            // ëŒ“ê¸€ ìˆ˜ì • í´ë¦­ ì´ë²¤íŠ¸
            document.querySelectorAll('.mod-comment-btn').forEach(modButton => {
                modButton.addEventListener('click', function (e) {
                    // ë¶€ëª¨ ì—˜ë¦¬ë¨¼íŠ¸(.comment)ì—ì„œ input ì—˜ë¦¬ë¨¼íŠ¸ ì°¾ê¸°
                    const inputElement = this.closest('.comment').querySelector('.comment-body .mod-input');
                    const pElement = inputElement.previousElementSibling;
                    const modButton = e.target;
                    console.log(pElement);

                    inputElement.classList.toggle('hide');
                    pElement.classList.toggle('hide');

                    // input ì—˜ë¦¬ë¨¼íŠ¸ì— class hideê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°
                    if (!inputElement.classList.contains('hide')) {
                        console.log(inputElement.value);
                        modButton.textContent = 'ì·¨ì†Œ';
                        inputElement.focus();
                        inputElement.addEventListener('keyup', modifyComment); // í‚¤ì—… ì´ë²¤íŠ¸ ë“±ë¡
                    }
                    else {
                        modButton.textContent = 'ìˆ˜ì •';
                        inputElement.removeEventListener('keyup', modifyComment); // í‚¤ì—… ì´ë²¤íŠ¸ ì‚­ì œ
                    }
                });
            });

            // ëŒ“ê¸€ ìˆ˜ì • í•¨ìˆ˜
            async function modifyComment(e){
                console.log(e.key);
                const rno = this.closest('.comment').id; // ëŒ“ê¸€ ê³ ìœ  ë²ˆí˜¸
                const content = e.target; // ëŒ“ê¸€ ì…ë ¥ì°½
                if (e.isComposing || content.value.trim() === '') return; // ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•ŠëŠ” ê²½ìš°

                if (e.key === 'Enter') {
                    console.log('ì—”í„°í‚¤ ëˆ„ë¦„');
                    console.log('ëŒ“ê¸€ì‘ì„± ë‚´ìš©: ', content.value);

                    // ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬í•  ê°ì²´
                    const replyObj = {
                        rno: rno,
                        content: content.value,
                    };

                    await modifyReply(replyObj)
                        .then(result => {
                            content.value = '';
                            alert(result.rno + 'ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                            printReplies(page, size);
                        })
                        .catch(e => {
                            console.log(e);
                            alert('ëŒ“ê¸€ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.');
                        });
                }
            }

            // ëŒ“ê¸€ ì‚­ì œ ë²„íŠ¼ ì „ì²´ ëª©ë¡
            document.querySelectorAll('.remove-comment-btn').forEach(removeBtn => {
               removeBtn.addEventListener('click', function (e) { // ëŒ“ê¸€ ì‚­ì œ í´ë¦­ ì´ë²¤íŠ¸
                   const rno = this.closest('.comment').id; // ì‚­ì œí•  ëŒ“ê¸€ì˜ rnoë¥¼ ê°€ì ¸ì˜´
                   console.log(rno);

                   removeReply(rno).then(result => {
                       alert(result.rno + 'ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                       page = 1; // í•´ë‹¹ ëŒ“ê¸€ì´ ì‚­ì œì‹œ 1í˜ì´ì§€ë¡œ ì´ë™
                       printReplies(page, size);
                   }).catch(e => {
                       console.log(e);
                   });
               });
            });

            // ëŒ€ëŒ“ê¸€ ìˆ¨ê¹€ ë²„íŠ¼ ì „ì²´ ëª©ë¡
            document.querySelectorAll('.hide-btn').forEach(hideButton => {
                hideButton.addEventListener('click', function (e) {
                    const replyList = this.closest('.comment').querySelector('.reply-list'); // ëŒ€ëŒ“ê¸€ ëª©ë¡
                    const replyCount = this.closest('.btn-area').dataset.replyCount;
                    console.log(replyList);
                    console.log(replyCount);

                    replyList.classList.toggle('hide');

                    if (!replyList.classList.contains('hide')) {
                        e.target.textContent = 'â–³ ìˆ¨ê¸°ê¸°';
                    }
                    else {
                        e.target.textContent = `â–½ ${replyCount}ê°œ ë‹µê¸€`;
                    }
                });
            });

            // ëŒ€ëŒ“ê¸€ ë“±ë¡ ë²„íŠ¼ ì „ì²´ ëª©ë¡
            document.querySelectorAll('.reg-reply-btn').forEach(registerButton => {
                registerButton.addEventListener('click', function (e) {
                    const inputElement = this.closest('.comment').querySelector('.reply-input'); // ëŒ€ëŒ“ê¸€ ì…ë ¥ì°½

                    inputElement.classList.toggle('hide');

                    if (!inputElement.classList.contains('hide')) { // ì…ë ¥ì°½ì´ í´ë˜ìŠ¤ì— hideê°€ ì—†ëŠ” ê²½ìš°
                        e.target.textContent = 'ì·¨ì†Œí•˜ê¸°';
                        inputElement.focus();
                        inputElement.addEventListener('keyup', registerReply); // í‚¤ì—… ì´ë²¤íŠ¸ ë“±ë¡
                    }
                    else {
                        e.target.textContent = 'ë‹µê¸€ë‹¬ê¸°';
                        inputElement.value = '';
                        inputElement.removeEventListener('keyup', registerReply); // í‚¤ì—… ì´ë²¤íŠ¸ ë“±ë¡
                    }
                });
            });
        }

        function printPages(data){ //í˜ì´ì§€ ëª©ë¡ ì¶œë ¥
            let pageStr = '';
            if (data.prev){ // ì´ì „ í˜ì´ì§€
                pageStr += `<li class="page-item"><a class="page-link" data-page="${data.start -1}">PREV</a></li>`;
            }
            for (let i = data.start; i <= data.end; i++){
                pageStr += `<li class="page-item ${i === data.page ? "active" : ""}">
                          <a class="page-link" data-page="${i}">${i}</a></li>`;
            }
            if (data.next){ // ë‹¤ìŒ í˜ì´ì§€
                pageStr += `<li class="page-item"><a class="page-link" data-page="${data.end + 1}">NEXT</a></li>`;
            }
            console.log(pageStr);
            replyPaging.innerHTML = pageStr;
        }

        const commentInput = document.getElementById('comment-input'); // ëŒ“ê¸€ ë“±ë¡ ì…ë ¥ì°½
        commentInput.addEventListener('keyup', registerReply); // í‚¤ì—… ì´ë²¤íŠ¸ ë“±ë¡

        // ëŒ“ê¸€ ë“±ë¡ í•¨ìˆ˜
        async function registerReply(e) {
            console.log(e.key);
            const content = e.target; // ëŒ“ê¸€ ì‘ì„± ë‚´ìš©
            const comment = content.closest('.comment'); // ëŒ“ê¸€ ê°€ì ¸ì˜¤ê¸°

            if (e.isComposing || content.value.trim() === '') return; // ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•ŠëŠ” ê²½ìš°

            if (e.key === 'Enter') {
                console.log('ì—”í„°í‚¤ ëˆ„ë¦„');
                console.log('ëŒ“ê¸€ì‘ì„± ë‚´ìš©: ', content.value);

                // ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬í•  ê°ì²´
                const replyObj = {
                    mno: 1, // ì„ì‹œ íšŒì› ë²ˆí˜¸
                    boardNo: boardNo,
                    content: content.value,
                    writer: 'testNick' // ì„ì‹œ ë‹‰ë„¤ì„
                };

                if (comment != null) { // ëŒ“ê¸€ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°
                    replyObj.parentNo = comment.id;
                }

                await addReply(replyObj).then(result => { //ë“±ë¡ì´ ëœ í›„ ê²°ê³¼ì²˜ë¦¬
                    alert(result.data.rno);
                    content.value = '';
                    printReplies(1, 10); //ëŒ“ê¸€ëª©ë¡ê°±ì‹ 
                }).catch(e => {
                    alert('exception');
                });
            }
        }

        // í˜ì´ì§• í´ë¦­
        let page = 1;
        let size = 10;
        replyPaging.addEventListener('click', function (e){
            e.preventDefault();
            e.stopPropagation();

            const target = e.target;
            if (!target || target.tagName != 'A'){
                return;
            }

            const pageNum = target.getAttribute("data-page");
            page = pageNum
            printReplies(page, size);
        }, false);

    });
</script>
</html>