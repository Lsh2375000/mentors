<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/inc.html}">

<head>
    <meta charset="UTF-8">
    <title>ìƒì„¸í˜ì´ì§€</title>
</head>

<body>


<div layout:fragment="content">
    <style>
        * { margin: 0; padding: 0; }
        ul, li { list-style: none; padding-left: 0; }
        a { text-decoration: none; }

        .view-container { background-color: #FFFFFF; }
        .view-body { min-height: 600px; }
        .view-footer { padding: 20px; text-align: right; }
        .comment-container { background-color: #f8f9fa; padding: 50px; }
        .comment-list { padding-top: 40px; }
        .comment { margin-bottom: 20px; padding: 20px 30px; border-radius: 5px; border: 1px solid #dee2e6; background-color: #FFFFFF; }
        .reply-list {margin: 20px 0; }
        .reply { border-left: 4px solid #9a9a9a; padding: 15px; }
    </style>

    <main>
        <div th:with="link = ${pageRequestDTO.getLink()}">
            <a th:href="|@{/board/list}?${link}|" class="text-decoration-none">
                <button type="button" class="btn btn-primary">ğŸ“‹ ë’¤ë¡œê°€ê¸°</button>
            </a>
            <th:block th:if="${#authentication.principal != 'anonymousUser'}">
                <a th:href="|@{/board/modify(boardNo=${board.boardNo})}&${link}|">
                    <button type="button" class="btn btn-secondary">âœ ìˆ˜ì •</button>
                </a>
            </th:block>
        </div>

        <!-- ê²Œì‹œê¸€ ì„¹ì…˜ -->
        <section class="view-container">

            <h1>[[${board.title}]]</h1>
            <div class="view-header">
                <h6><a href="#">[[${board.writer}]]</a></h6>
                <span>ì‘ì„±ì¼ &nbsp;[[${#temporals.format(board.addDate, 'yyyy-MM-dd HH:mm')}]]</span>
                <span>ì¡°íšŒìˆ˜ &nbsp;[[${board.replyCount}]]</span>
            </div>
            <hr>
            <div class="view-body" th:utext="${board.content}"></div>
            <div class="view-footer">
                <form action="/board/remove" method="post">
                    <button type="button" id="likeBtn" class="btn btn-primary">ì¢‹ì•„ìš”</button>
                    <a th:href="|@{/board/modify(boardNo=${board.boardNo})}&${link}|">
                        <button type="button" class="btn btn-secondary">âœ ìˆ˜ì •</button>
                    </a>
                    <button type="submit" id="removeBtn" class="btn btn-danger">ì‚­ì œ</button>
                </form>
            </div>

            <script th:inline="javascript">
                // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë²¤íŠ¸
                const boardNo = [[${board.boardNo}]];
                document.getElementById('removeBtn').addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const form = document.querySelector('.view-footer form');

                    if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        form.innerHTML += `<input type="hidden" name="boardNo" value="${boardNo}">`;
                        form.submit();
                    }
                });

            </script>

        </section>

        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
        <section class="comment-container">
            <h3>ëŒ“ê¸€ <span>[[${board.replyCount}]]</span></h3>
            <input type="text" id="comment-input" name="content" class="form-control" placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”">
            <ul class="comment-list">

            </ul>
            <ul class="pagination reply-paging">

            </ul>
        </section>
    </main>

    <!-- register modal start -->
    <div class="modal registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Register Reply</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text">content</span>
                        <input type="text" class="form-control replyContent">
                    </div>

                    <div class="input-group mb-3">
                        <span class="input-group-text">nickname</span>
                        <input type="text" class="form-control replyNickname" th:value="${board.writer}" name="nickname">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary registerBtn">ëŒ“ê¸€ ë‹¬ê¸°</button>
                    <button type="button" class="btn btn-outline-dark closeRegisterBtn">ì°½ ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
    <!-- register modal end -->
    <!-- modify modal start-->
    <div class="modal modifyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title replyHeader"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text">Reply Text</span>
                        <input type="text" class="form-control modifyText">
                    </div>
                </div>
                <div class="modal-footer">
<!--                    <button type="button" class="btn btn-info modifyBtn" th:value="${#authentication.principal.nickname}">ìˆ˜ì •</button>-->
<!--                    <button type="button" class="btn btn-danger removeBtn" th:value="${#authentication.principal.nickname}">ì‚­ì œ</button>-->
                    <button type="button" class="btn btn-outline-dark closeModifyBtn">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- modify modal end-->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/board/board.js"></script>
    <script src="/js/reply.js"></script>

</div> <!-- reply end -->
</body>
<script layout:fragment="script" th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const boardNo = [[${board.boardNo}]];

        // ì¢‹ì•„ìš” ì¶”ê°€ ì´ë²¤íŠ¸
        document.getElementById('likeBtn').addEventListener('click', async function (e) {
            e.preventDefault();
            e.stopPropagation();

            const boardLikeDTO = { boardNo: boardNo, mno: 2 };

            const result = await addLike(boardLikeDTO);
            console.log(result);
            e.target.disabled = 'true';
        });

        function printReplies(page, size, goLast){
            getList({boardNo, page, size, goLast}).then(
                data => {console.log(data);
                    printList(data.dtoList);
                    printPages(data);
                }
            ).catch(e => {
                console.error();
            });
        }
        printReplies(1, 10); //ë¬´ì¡°ê±´ í˜¸ì¶œ
        // printReplies(1, 10, true);

        const commentList = document.querySelector('.comment-list');//ëŒ“ê¸€ ëª©ë¡ DOM
        const replyPaging = document.querySelector('.reply-paging'); //í˜ì´ì§€ ëª©ë¡ DOM

        function printList(dtoList){ //ëŒ“ê¸€ ëª©ë¡ ì¶œë ¥
            let str = '';
            let date;
            let dateFomatter;
            if (dtoList && dtoList.length > 0){
                for(const comment of dtoList){ // ëŒ“ê¸€
                    date = comment.addDate; // ëŒ“ê¸€ ë“±ë¡ ë‚ ì§œ
                    dateFomatter = `${date[0]}-${date[1]}-${date[2]} ${date[3]}:${date[4]}`; // ë‚ ì§œ í¬ë§·
                    console.log(date);
                    str += `<li class ="comment">
                            <div class="comment-header">
                                <h6><a href="#">${comment.writer}</a></h6>
                                <span>${dateFomatter}</span>
                                <span>
                                    <button id="modCommentBtn">ìˆ˜ì •</button>
                                    <button class="remove-comment-btn" data-rno="${comment.rno}">ì‚­ì œ</button>
                                </span>
                            </div>
                            <hr>
                            <div class="comment-body">
                                <p>${comment.content}</p>
                                <div>
                                    <button>ìˆ¨ê¸°ê¸° / ë”ë³´ê¸°</button>
                                    <button>ë‹µê¸€ë‹¬ê¸°</button>
                                </div>
                            </div>
                            <ul class="reply-list">`;
                    for (const reply of comment.children) { // ëŒ€ëŒ“ê¸€
                        date = reply.addDate; // ëŒ€ëŒ“ê¸€ ë“±ë¡ ë‚ ì§œ
                        dateFomatter = `${date[0]}-${date[1]}-${date[2]} ${date[3]}:${date[4]}`; // ë‚ ì§œ í¬ë§·
                        str += `<li class="reply">
                                <div>
                                    <span>${reply.writer}</span>
                                    <span>&nbsp;Â·&nbsp;</span>
                                    <span>${dateFomatter}</span>
                                </div>
                                <p>${reply.content}</p>
                             </li>`;
                    }
                    str += `</ul></li>`;
                }
            }
            commentList.innerHTML = str;
        }

        function printPages(data){ //í˜ì´ì§€ ëª©ë¡ ì¶œë ¥
            let pageStr = '';
            if (data.prev){ // ì´ì „ í˜ì´ì§€
                pageStr += `<li class="page-item"><a class="page-link" data-page="${data.start -1}">PREV</a></li>`;
            }
            for (let i = data.start; i <= data.end; i++){
                pageStr += `<li class="page-item ${i === data.page ? "active" : ""}">
                          <a class="page-link" data-page="${i}">${i}</a></li>`;
            }
            if (data.next){ // ë‹¤ìŒ í˜ì´ì§€
                pageStr += `<li class="page-item"><a class="page-link" data-page="${data.end + 1}">NEXT</a></li>`;
            }
            console.log(pageStr);
            replyPaging.innerHTML = pageStr;
        }

        const registerModal = new bootstrap.Modal(document.querySelector('.registerModal'));
        const commentInput = document.getElementById('comment-input'); // ëŒ“ê¸€ ë“±ë¡ ì…ë ¥ì°½

        // ëŒ“ê¸€ë“±ë¡
        commentInput.addEventListener('keyup', async function (e){
            console.log(e.key);
            const content = e.target; // ëŒ“ê¸€ ì‘ì„± ë‚´ìš©
            if (e.isComposing || content.value.trim() === '') return; // ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•ŠëŠ” ê²½ìš°

            if (e.key === 'Enter') {
                console.log('ì—”í„°í‚¤ ëˆ„ë¦„');
                console.log('ëŒ“ê¸€ì‘ì„± ë‚´ìš©: ', content.value);

                // ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬í•  ê°ì²´
                const replyObj = {
                    boardNo: boardNo,
                    content: content.value,
                    writer: 'testNick' // ì„ì‹œ ë‹‰ë„¤ì„
                };

                await addReply(replyObj).then(result => { //ë“±ë¡ì´ ëœ í›„ ê²°ê³¼ì²˜ë¦¬
                    alert(result.data.rno);
                    content.value = '';
                    printReplies(1, 10); //ëŒ“ê¸€ëª©ë¡ê°±ì‹ 
                }).catch(e => {
                    alert('exception');
                });
            }
        });

        // 3. í˜ì´ì§• í´ë¦­
        let page = 1;
        let size = 10;
        replyPaging.addEventListener('click', function (e){
            e.preventDefault();
            e.stopPropagation();

            const target = e.target;
            if (!target || target.tagName != 'A'){
                return;
            }

            const pageNum = target.getAttribute("data-page");
            page = pageNum
            printReplies(page, size);
        }, false);

        // 4. ëŒ“ê¸€ ìˆ˜ì • ê´€ë ¨
        const modifyModal = new bootstrap.Modal(document.querySelector('.modifyModal'));
        const replyHeader = document.querySelector('.replyHeader');
        const modifyText = document.querySelector('.modifyText');
        const modCommentBtn = document.querySelector('.modCommentBtn');
        const removeCommentBtn = document.querySelector('.removeCommentBtn');
        const closeModifyBtn = document.querySelector('.closeModifyBtn');

        // ëŒ“ê¸€ ë‚´ìš©ì„ í´ë¦­í–ˆì„ ë•Œ ìˆ˜ì • ëª¨ë‹¬ì°½ ë„ìš°ê¸°!
        // replyList.addEventListener('click', function (e){
        //     e.preventDefault();
        //     e.stopPropagation();
        //
        //     const target = e.target;
        //     if(!target || target.tagName != 'SPAN'){
        //         return;
        //     }
        //     const rno = target.getAttribute("data-rno");
        //     if (!rno){
        //         return;
        //     }
        //
        //     getReply(rno).then(reply => {
        //         console.log(reply);
        //         replyHeader.innerHTML = reply.rno;
        //         modifyText.value = reply.content;
        //         modifyModal.show();
        //     }).catch(e => alert('error'));
        // });

        //ëŒ“ê¸€ ëª¨ë‹¬ì°½ ìˆ˜ì •
        // modCommentBtn.addEventListener('click', function (e) {
        //     console.log('modifyBtn...click');
        //     const replyObj = { boardNo: boardNo, rno: replyHeader.innerHTML, content: modifyText.value };
        //     modifyReply(replyObj)
        //         .then(result => {
        //             alert(result.rno + 'ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
        //             modifyText.value = '';
        //             modifyModal.hide();
        //             printReplies(page, size);
        //         })
        //         .catch(e => {
        //             console.log(e);
        //             alert('ëŒ“ê¸€ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.');
        //             return;
        //         });
        // });

        //5. ëŒ“ê¸€ ì‚­ì œ ê´€ë ¨
        commentList.addEventListener('click', function (e) {

            if (e.target.classList.contains('remove-comment-btn')) { // ì‚­ì œ ë²„íŠ¼ì´ í´ë¦­ëœ ê²½ìš°
                const rno = e.target.dataset.rno; // ì‚­ì œí•  ëŒ“ê¸€ì˜ IDë¥¼ ê°€ì ¸ì˜´
                console.log(rno);

                removeReply(rno).then(result => {
                    alert(result.rno + 'ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    page = 1; // í•´ë‹¹ ëŒ“ê¸€ì´ ì‚­ì œì‹œ 1í˜ì´ì§€ë¡œ ì´ë™
                    printReplies(page, size);
                }).catch(e => {
                    console.log(e);
                });
            }
        });
    });
</script>
</html>