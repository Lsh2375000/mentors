<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <style layout:fragment="style">
        .hide {display: none;}
        .fail {color: #ff0000;}
        .success-message {color: #00ff00;}
        .failure-message, .failure-message2, .mismatch-message {color: #ff0000;}
    </style>
</head>
<body>

    <div layout:fragment="content">
        <div class="row">
            <div class="col-lg-8" data-aos="fade-up" data-aos-delay="200">
                <form th:action="@{/member/signup}" method="post" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-10 mb-3">
                            <input id="memberId" type="text" class="form-control" name="memberId" minlength="5" maxlength="20" placeholder="아이디">
                            <span class="success-message hide">사용할 수 있는 아이디입니다</span>
                            <span class="failure-message hide">아이디는 5 ~ 20글자이어야 합니다</span>
                            <span class="failure-message2 hide">영어 또는 숫자만 가능합니다</span>
                        </div>
                        <div class="col-2 mb-3">
                            <button id="checkIdBtn" type="button" class="btn btn-primary">중복검사</button>
                        </div>

                        <div class="col-6 mb-3">
                            <input id="passwd" type="password" class="form-control" name="passwd" placeholder="비밀번호">
                            <span class="strongPassword-message">8글자 이상, 영문, 숫자, 특수문자(@$!%*#?&)를 사용하세요</span>
                        </div>
                        <div class="col-6 mb-3">
                            <input id="password-retype" type="password" class="form-control" placeholder="비밀번호 확인">
                            <span class="mismatch-message hide">비밀번호가 일치하지 않습니다</span>
                        </div>

                        <!-- 전화번호 -->
                        <div class="col-4 mb-3">
                            <select id="phoneSelect" class="form-select input-phone" style="height: 54px;">
                                <option selected>010</option>
                                <option>011</option>
                                <option>016</option>
                                <option>017</option>
                                <option>019</option>
                            </select>
                        </div>
                        <div class="col-4 mb-3">
                            <input type="number" class="form-control input-phone" placeholder="1234">
                        </div>
                        <div class="col-4 mb-3">
                            <input type="number" class="form-control input-phone" placeholder="5678">
                            <input type="hidden" name="phone">
                        </div>

                        <div class="col-4 mb-3">
                            <input id="emailId" type="text" class="form-control" placeholder="이메일">
                        </div>

                        <div class="col-4 mb-3">
                            <input id="domain" type="text" class="form-control" placeholder="ex) @example.com">
                            <input type="hidden" name="email">
                        </div>

                        <div class="col-2 mb-3">
                            <select id="domainSelect" class="form-select" style="height: 54px;">
                                <option name="domain" value="-1" selected>직접입력</option>
                                <option name="domain" value="@naver.com">naver.com</option>
                                <option name="domain" value="@daum.net">daum.net</option>
                                <option name="domain" value="@gmail.com">gmail.com</option>
                            </select>
                        </div>

                        <div class="col-2 mb-3">
                            <button id="emailBtn" type="button" class="btn btn-primary" style="height: 54px;">인증하기</button>
                        </div>

                        <div class="col-6 mb-3">
                            <input type="text" name="confirmKey" class="form-control" placeholder="인증번호">
                        </div>
                        <div class="col-6 mb-3">
                            <button id="confirmKeyBtn" type="button" class="btn btn-primary">확인</button>
                        </div>

                        <div class="col-6 mb-3">
                            <input id="memberName" type="text" name="memberName" class="form-control" placeholder="이름"/>
                        </div>
                        <div class="col-6 mb-3">
                            <input id="nickName" type="text" name="nickName" class="form-control" minlength="2" maxlength="15" placeholder="닉네임"/>
                            <span class="nickNameCheck-message fail">2 ~ 15글자, 숫자, 영어, 한글을 사용하세요.</span>
                        </div>

                        <div class="col-12 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="hasCat" value="false" role="switch" id="hasCat">
                                <label class="form-check-label" for="hasCat">고양이를 키우고 계신가요?</label>
                            </div>

                            <div class="row catInfo hide">
                                <div class="col-6 mb-3">
                                    <input id="catAge" type="text" class="form-control" placeholder="고양이 나이">
                                    <input type="hidden" name="catAge">
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="form-check-inline">
                                        <input class="form-check-input" type="radio" name="ageRdo" id="month" value="개월">
                                        <label class="form-check-label" for="month">개월</label>
                                    </div>
                                    <div class="form-check-inline">
                                        <input class="form-check-input" type="radio" name="ageRdo" id="year" value="년">
                                        <label class="form-check-label" for="year">년</label>
                                    </div>
                                </div>

                                <div class="col-6 mb-3">
                                    <input type="text" name="variety" class="form-control" placeholder="품종">
                                </div>

                                <div class="col-6 mb-3">
                                    <select id="varietySelect" class="form-select" style="height: 54px;">
                                        <option value="-1" selected>직접입력</option>
                                        <option> 코리안 숏 헤어 </option>
                                        <option> 노르웨이 숲 </option>
                                        <option> 페르시안 </option>
                                        <option> 샴 </option>
                                    </select>
                                </div>

                                <div class="col-6 mb-3">
                                    <label for="profileImg" class="form-label">프로필 이미지</label>
                                    <input class="form-control" type="file" name="files" id="profileImg" style="height: 35px;">
                                    <div class="uploadResult"></div>
                                    <div class="uploadHidden"></div>
                                </div>
                                <div class="col-6 mb-3">
                                    <div>성별</div>
                                    <div class="form-check-inline">
                                        <input class="form-check-input" type="radio" name="catSex" id="male">
                                        <label class="form-check-label" for="male">남아</label>
                                    </div>
                                    <div class="form-check-inline">
                                        <input class="form-check-input" type="radio" name="catSex" id="female">
                                        <label class="form-check-label" for="female">여아</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <button type="button" class="btn btn-primary submitBtn">회원가입</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="/js/signup/validation.js"></script>
        <script src="/js/signup/upload.js"></script>
    </div>

    <script layout:fragment="script" th:inline="javascript">
        const errors = [[${errors}]];
        console.log(errors);

        let errorMsg = '';

        if (errors) {
            for (const error of errors) {
                errorMsg += `${error.field}은(는) ${error.code} \n`;
            }
            alert(errorMsg);
        }

        const fileInput = document.querySelector('input[name=files]');
        fileInput.addEventListener('change', function () {
            const formObj = new FormData();
            const files = fileInput.files;
            console.log(files);

            for (const file of files) {
                formObj.append('files', file);
            }

            uploadToSrver('/upload/tempUpload', formObj).then(result => {
                console.log(result);
                for (const uploadResult of result) {
                    showUploadFile(uploadResult);
                }
                console.log(files);
            });
        });

        // 업로드된 이미지를 보여줌
        const uploadResult = document.querySelector('.uploadResult');

        function showUploadFile({dateFolder, fileName, link}) {
            const str = `<div>
                            <img src="/upload/tempView/${dateFolder}/${link}" data-src="${fileName}/${dateFolder}">
                         </div>`
            uploadResult.innerHTML = str;
        }

        // 회원가입 등록 처리
        document.querySelector('.submitBtn').addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            // 1. 썸네일 영역에서 img 태그의 data-src 속성을 들고 옴.
            const uploadFile = uploadResult.querySelector('img');
            console.log(uploadResult);
            let str = '';
            const imgLink = uploadFile.getAttribute('data-src');

            str = `<input type="hidden" name="profileImg" value="${imgLink}">`;

            // 2. 프로필 사진 첨부 영역에 태그 추가
            document.querySelector('.uploadHidden').innerHTML = str;

            // 3. submit() 처리
            const formObj = document.querySelector('form');
            formObj.submit();
        });

        const inputMemberId = document.getElementById('memberId');
        const inputPasswd = document.getElementById('passwd');
        const inputPasswdRetype = document.getElementById('password-retype');

        // 아이디 유효성 검사
        inputMemberId.addEventListener('keyup', function () {
            const memberId = inputMemberId.value;
            const successMsg = document.querySelector('.success-message');
            const failureMsg = document.querySelector('.failure-message');
            const failureMsg2 = document.querySelector('.failure-message2');

            // 값을 입력한 경우
            if (memberId.length !== 0) {
                // 영어 또는 숫자 외의 값을 입력했을 경우
                if(!onlyNumbersAndEnglish(memberId)) {
                    successMsg.classList.add('hide'); // 성공 메시지가 가려져야 함
                    failureMsg.classList.add('hide'); // 실패 메시지가 가려져야 함
                    failureMsg2.classList.remove('hide'); // 영어 또는 숫자만 가능합니다
                }
                // 글자 수가 4~12글자가 아닐 경우
                else if(!idLength(memberId)) {
                    successMsg.classList.add('hide'); // 성공 메시지가 가려져야 함
                    failureMsg.classList.remove('hide'); // 아이디는 4~12글자이어야 합니다
                    failureMsg2.classList.add('hide'); // 실패 메시지2가 가려져야 함
                }
                // 조건을 모두 만족할 경우
                else if(idLength(memberId) && onlyNumbersAndEnglish(memberId)) {
                    successMsg.classList.remove('hide'); // 사용할 수 있는 아이디입니다
                    failureMsg.classList.add('hide'); // 실패 메시지가 가려져야 함
                    failureMsg2.classList.add('hide'); // 실패 메시지2가 가려져야 함
                }
            }
            // 값을 입력하지 않은 경우 (지웠을 때) 모두 가린다
            else {
                successMsg.classList.add('hide');
                failureMsg.classList.add('hide');
                failureMsg2.classList.add('hide');
            }
        });

        // 아이디 중복체크
        document.getElementById('checkIdBtn').addEventListener('click', async function () {
            const memberId = inputMemberId.value;
            const result = await checkMemberId(memberId);
            console.log(result);
            if (result === "true") { // 아이디가 존재할때
                alert("이미 존재하는 아이디 입니다.");
            }
            else {
                alert("사용할 수 있는 아이디 입니다.");
            }
        });

        // 비밀번호 유효성 검사
        inputPasswd.addEventListener('keyup', function () {
            const passwd = inputPasswd.value;
            const strongPasswdMsg = document.querySelector('.strongPassword-message');
            if (passwd.length !== 0) {
                !strongPassword(passwd) ? strongPasswdMsg.classList.add('fail') : strongPasswdMsg.classList.remove('fail');
            }
            else {
                strongPasswdMsg.classList.add('fail');
            }
        });

        // 비밀번호 확인
        inputPasswdRetype.addEventListener('keyup', function () {
            const misMatchMsg = document.querySelector('.mismatch-message');

            if (inputPasswdRetype.value.length !== 0) {
                if(isMatch(inputPasswd.value, inputPasswdRetype.value)) {
                    misMatchMsg.classList.add('hide'); // 실패 메시지가 가려져야 함
                }
                else {
                    misMatchMsg.classList.remove('hide'); // 실패 메시지가 보여야 함
                }
            }
            else {
                misMatchMsg.classList.add('hide'); // 실패 메시지가 가려져야 함
            }
        });

        // 도메인 셀렉트박스
        const domainSelect = document.getElementById('domainSelect');
        const domainInput = document.getElementById('domain');
        domainSelect.addEventListener('change', function (e) {
            console.log(e.target.value);
            // 기타입력 아닐때
            if (e.target.value !== "-1") {
                console.log("비활성");
                domainInput.disabled = true;
                domainInput.value = e.target.value;
            }
            else {
                domainInput.disabled = false;
                domainInput.value = "";
                domainInput.focus();
            }
        });

        // 이메일 인증번호 전송
        let currentTime = 0;
        const email = document.querySelector('input[name=email]'); // 이메일을 담을 input
        document.getElementById('emailBtn').addEventListener('click', async function (e) {
            const emailId = document.getElementById('emailId').value;
            const domain = domainInput.value;
            const mailTo = emailId + domain;

            let timerInterval; // setInterval id 값
            currentTime = 1000 * 60 * 3; // 타이머 시간

            if (!isEmailValid(mailTo)) {
                alert("올바른 이메일 주소를 작성해주세요.");
            }
            else {
                const result = await sendConfirmMail(mailTo);
                if (result.toString() === "true") {
                    alert('인증번호가 전송되었습니다.');
                    // 이메일 저장
                    email.value = mailTo;
                    // 인증하기 버튼 비활성화
                    e.target.disabled = true;

                    // 이메일 인증 타이머
                    timerInterval = setInterval(function () {

                        if (currentTime <= 0) { // 남은 시간이 0초 일때
                            clearInterval(timerInterval);
                            removeConfirmKey(); // 세션에 저장된 인증코드 삭제
                            e.target.disabled = false; // 인증하기 버튼 활성화
                            e.target.textContent = '인증하기';

                            return;
                        }

                        const sec = (currentTime / 1000) % 60;
                        const min = Math.floor(currentTime / (60 * 1000));
                        e.target.textContent = `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
                        currentTime = currentTime - 1000;
                    }, 1000);
                }
                else {
                    alert('인증번호 전송 실패');
                }
            }
        });

        // 이메일 인증번호 확인
        document.getElementById('confirmKeyBtn').addEventListener('click', async function () {
            const confirmKeyInput = document.querySelector('input[name=confirmKey]');
            const result = await matchConfirmKey(confirmKeyInput.value);

            if (result === "true") {
                alert('인증이 완료되었습니다.');
                currentTime = 0; // 타이머 초기화
            }
            else {
                alert('인증 실패');
                // 이메일 인증 실패시 초기화
                email.value = "";
            }
        });

        const phoneInputs = document.querySelectorAll('input.input-phone');
        const phoneHiddenInput = document.querySelector('input[name=phone]');
        let phoneOptValue = document.getElementById('phoneSelect').value;
        // 전화번호 앞자리 셀렉트 박스
        document.getElementById('phoneSelect').addEventListener('change', function (e) {
            phoneOptValue = e.target.value;
            phoneHiddenInput.value = `${phoneOptValue}-${phoneInputs[0].value}-${phoneInputs[1].value}`;
        });
        // 전화번호 중간 뒷자리
        phoneInputs.forEach(input => {
            input.addEventListener('change', function () {
                phoneHiddenInput.value = `${phoneOptValue}-${phoneInputs[0].value}-${phoneInputs[1].value}`;
            });
        });

        // 닉네임 확인
        document.querySelector('input[name=nickName]').addEventListener('keyup', function (e) {
            const nickName = e.target.value;
            const checkMsg = document.querySelector('.nickNameCheck-message');
            console.log(nickName);

            if (!onlyNumbersAndEnglishAndKorean(nickName)) {
                checkMsg.classList.add('fail');
            }
            else {
                checkMsg.classList.remove('fail');
            }
        });

        // 고양이 보유 여부
        document.querySelector('input[name=hasCat]').addEventListener('change', function (e) {
            const catInfo = document.querySelector('.catInfo');
            console.log(e.target.checked);
            if (e.target.checked){ // 고양이를 키우고 있을 때
                catInfo.classList.remove('hide');
            }
            else { // 고양이를 키우고 있지 않을 때
                catInfo.classList.add('hide');
            }

            // switch value 업데이트 true, false
            e.target.value = e.target.checked;
        });

        // 고양이 나이 라디오 버튼
        document.querySelectorAll('input[name=ageRdo]').forEach(rdo => {
            rdo.addEventListener('change', function (e) {
                const catAge = document.getElementById('catAge').value;
                const hiddenInput = document.querySelector('input[name=catAge]');

                hiddenInput.value = '';
                hiddenInput.value = catAge + rdo.value;
            });
        });

        // 품종 셀렉트 박스
        document.getElementById('varietySelect').addEventListener('change', function (e) {
            const varietyInput = document.querySelector('input[name=variety]');

            if (e.target.value != "-1") {
                varietyInput.readOnly = true;
                varietyInput.value = e.target.value;
            }
            else {
                varietyInput.readOnly = false;
                varietyInput.value = '';
            }
        });
    </script>
</body>
</html>